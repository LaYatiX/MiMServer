<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8">
    <title>Analyser</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="jquery-3.2.1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
</head>

<body onload="init();">

    <div class="grid">

        <div class ="container" id="v1-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="v1">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                Volts
                </text>
                </g>
        </svg>
        </div>

        <div class ="container" id="v2-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="v2">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                    Volts
                </text>
                </g>
            </svg>
        </div>

        <div class ="container" id="v3-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="v3">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                    Volts
                </text>
                </g>
            </svg>
        </div>

        <div class ="container" id="c1-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="c1">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                    Amperes
                </text>
                </g>
            </svg>
        </div>
    
        <div class ="container" id="c2-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="c2">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                    Amperes
                </text>
                </g>
            </svg>
        </div>
    
        <div class ="container" id="c3-box">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class ="rounded-bar" id="c3">
                <circle class="backdrop" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <circle class="progress" r="39.7887357725" cy="50" cx="50" fill="none"/>
                <g transform="rotate(90, 50, 50)" class="bar-text">
                <text x="50" y="50" class="bar-number">
                </text>
                <text x="50" y="50" class="bar-label">
                    Amperes
                </text>
                </g>
            </svg>
        </div>

        <div id="graph-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 500" id="line-graph" >
                <rect id="outside-line" x="3" y="3" rx="20" ry="20" width="954" height="494"></rect>
            </svg>
        </div>
  
    </div>

    <script>

    var arrayOfValues = [];

    function init() {
        getData();
    }

    function getData() {
        window.WebSocket = window.WebSocket || window.MozWebSocket;
        var connection = new WebSocket("ws://pkprojectserver.hopto.org:1337");

        connection.onopen = function () {
            console.log('WebSocket Status: OPEN');
        }

        connection.onmessage = function(message) {
            arrayOfValues = message.data.split(";");

            updateContent(arrayOfValues);
        }

        var tick = 0,
            amplitude = 250,
            angularFrequency = 0.32;

        setInterval(function() {
            function setValue(value, phase = 0) {
                arrayOfValues[value] = amplitude * Math.sin(tick / 10 * (angularFrequency + 0.5) + phase);
            }
            
            for (let sentinel = 0, phase = 0; sentinel < 6; sentinel = sentinel + 2, phase = phase - 20) {
                setValue(sentinel, phase);
            }

            ++tick;

            updateContent(arrayOfValues);
            performTransition = true;
            data.push(arrayOfValues[0]);
        }, duration);
    }

    function updateContent(outputArray) {
        for (let sentinel = 0; sentinel < outputArray.length; ++sentinel) {
            var value = +outputArray[sentinel];
            var $circle = $('.progress');
            
            if (isNaN(value)) {
                value = 250;
            }
            else {
                var radius = $circle.eq(sentinel).attr('r');
                var circumference = Math.PI * (radius * 2);
            
                if (value < -250) {
                    value = 0;
                }

                if (value > 250) {
                    value = 250;
                }
                
                var fillingValue = ((250 - value) / 250) * circumference;
                
                $circle.eq(sentinel).css({
                    strokeDashoffset: fillingValue
                });
                $('.bar-number').eq(sentinel).html(parseInt(value));
            }
        }
    }

    var proxied = new Proxy(arrayOfValues, {
        get: function(target, prop) {
            console.log({ type: 'get', target, prop });
            return Reflect.get(target, prop);
        },
        set: function(target, prop, value) {
            console.log({ type: 'set', target, prop, value });
            return Reflect.set(target, prop, value);
        }
    });

    var duration = 6, field = 70, domain = 300,
        random = d3.randomNormal(0, 70),
        data = d3.range(field),
        random2 = d3.randomNormal(0, 70),
        data2 = d3.range(field).map(random2),
        random3 = d3.randomNormal(0, 70),
        data3 = d3.range(field).map(random3);

    data.fill('0');
    data2.fill('0');
    data3.fill('0');

    var svg = d3.select("#line-graph"),
        margin = {top: 25, right: 25, bottom: 25, left: 50},
        viewBox = svg.attr("viewBox").split(" "),
        size = viewBox.slice(2),
        width = size[0] - margin.left - margin.right,
        height = size[1] - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleLinear()
        .domain([0, field - 1])
        .range([0, width]);

    var y = d3.scaleLinear()
        .domain([-domain, domain])
        .range([height, 0]);

    var line = d3.line()
        .x(function(d, i) { return x(i); })
        .y(function(d, i) { return y(d); });

    var performTransition = false;

    g.append("defs")
    .append("clipPath")
        .attr("id", "clip")
    .append("rect")
        .attr("width", width)
        .attr("height", height);

    g.append("g")
        .attr("clip-path", "url(#clip)")
    .append("path")
        .datum(data)
        .attr("class", "line")
    .transition()
        .duration(duration)
        .ease(d3.easeLinear)
        .on("start", function repeat() {
            //if(proxied.arrayOfValues)
            //{
            
            //data.push(arrayOfValues[0]);
        d3.select(this)
            .attr("d", line)
            .attr("transform", null);
        d3.active(this)
            .attr("transform", "translate(" + x(-1) + ",0)")
        .transition()
            .on("start", repeat);
            data.shift();
           // }
        })
        
        ;

        // .on("start", function repeat() {
        //     data.push(arrayOfValues[0]);
        // d3.select(this)
        //     .attr("d", line)
        //     .attr("transform", null);
        // d3.active(this)
        //     .attr("transform", "translate(" + x(-1) + ",0)")
        // .transition()
        //     .on("start", repeat);
        //     data.shift();
        // });

    g.append("g")
        .attr("clip-path", "url(#clip)")
    .append("path")
        .datum(data2)
        .attr("class", "line2")
    .transition()
        .duration(duration)
        .ease(d3.easeLinear)
        .on("start", function repeat() {
            data2.push(arrayOfValues[2]);
        d3.select(this)
            .attr("d", line)
            .attr("transform", null);
        d3.active(this)
            .attr("transform", "translate(" + x(-1) + ",0)")
        .transition()
            .on("start", repeat);
            data2.shift();
            });

    g.append("g")
        .attr("clip-path", "url(#clip)")
    .append("path")
        .datum(data3)
        .attr("class", "line3")
    .transition()
        .duration(duration)
        .ease(d3.easeLinear)
        .on("start", function repeat() {
            data3.push(arrayOfValues[4]);
        d3.select(this)
            .attr("d", line)
            .attr("transform", null);
        d3.active(this)
            .attr("transform", "translate(" + x(-1) + ",0)")
        .transition()
            .on("start", repeat);
            data3.shift();
            });

    g.append("g")
        .attr("class", "axisStyle")
        .call(d3.axisLeft(y));

    g.append("g")
        .attr("class", "axisStyle")
        .attr("transform", "translate(0," + y(0) + ")")
        .call(d3.axisBottom(x));

         // .on("start", function repeat() {
        //     $('#arrayOfValues').on('change', function() {
        //         .push(arrayOfValues[0]);
        //     d3.select(this)
        //         .attr("d", line)
        //         .attr("transform", null);
        //     d3.active(this)
        //         .attr("transform", "translate(" + x(-1) + ",0)")
        //     .transition()
        //         .on("start", repeat);
        //         data.shift();
        //     })
        // });

    </script>

</body>

</html>